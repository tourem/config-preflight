name: Release to Maven Central

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
    - name: Import GPG key
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 --decode | gpg --batch --import
        
    - name: Set release version
      run: |
        mvn versions:set -DnewVersion=${{ inputs.release-version }} -DgenerateBackupPoms=false
        git add pom.xml */pom.xml
        git commit -m "Release version ${{ inputs.release-version }}"
        git tag -a v${{ inputs.release-version }} -m "Release version ${{ inputs.release-version }}"
        
    - name: Configure Maven settings
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml <<EOF
        <settings>
          <servers>
            <server>
              <id>central</id>
              <username>${{ secrets.SONATYPE_USERNAME }}</username>
              <password>${{ secrets.SONATYPE_TOKEN }}</password>
            </server>
          </servers>
        </settings>
        EOF
        
    - name: Build and deploy to Maven Central
      env:
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        mvn clean deploy -Prelease -DskipTests -B \
          -Dgpg.passphrase="${GPG_PASSPHRASE}" \
          -Dgpg.keyname=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2 | head -n1)
          
    - name: Calculate next snapshot version
      id: next-version
      run: |
        RELEASE_VERSION="${{ inputs.release-version }}"
        IFS='.' read -ra VERSION_PARTS <<< "$RELEASE_VERSION"
        MAJOR="${VERSION_PARTS[0]}"
        MINOR="${VERSION_PARTS[1]}"
        PATCH="${VERSION_PARTS[2]}"
        NEXT_PATCH=$((PATCH + 1))
        NEXT_SNAPSHOT="${MAJOR}.${MINOR}.${NEXT_PATCH}-SNAPSHOT"
        echo "next-snapshot=$NEXT_SNAPSHOT" >> $GITHUB_OUTPUT
        echo "Next snapshot version: $NEXT_SNAPSHOT"
        
    - name: Set next snapshot version
      run: |
        mvn versions:set -DnewVersion=${{ steps.next-version.outputs.next-snapshot }} -DgenerateBackupPoms=false
        git add pom.xml */pom.xml
        git commit -m "Prepare next development iteration ${{ steps.next-version.outputs.next-snapshot }}"
        
    - name: Update demo projects with new snapshot version
      run: |
        echo "Updating demo projects to use config-preflight version: ${{ steps.next-version.outputs.next-snapshot }}"
        cd tests/spring-boot-test
        mvn versions:set-property -Dproperty=config-preflight.version -DnewVersion=${{ steps.next-version.outputs.next-snapshot }} -DgenerateBackupPoms=false
        cd ../quarkus-test
        mvn versions:set-property -Dproperty=config-preflight.version -DnewVersion=${{ steps.next-version.outputs.next-snapshot }} -DgenerateBackupPoms=false
        cd ../micronaut-test
        mvn versions:set-property -Dproperty=config-preflight.version -DnewVersion=${{ steps.next-version.outputs.next-snapshot }} -DgenerateBackupPoms=false
        cd ../..
        
    - name: Update documentation with release version
      run: |
        echo "Updating documentation to reference release version: ${{ inputs.release-version }}"
        # Update README.md
        sed -i "s/<version>.*-SNAPSHOT<\/version>/<version>${{ inputs.release-version }}<\/version>/g" README.md
        
        # Update DOCUMENTATION.md
        sed -i "s/<version>.*-SNAPSHOT<\/version>/<version>${{ inputs.release-version }}<\/version>/g" DOCUMENTATION.md
        
        # Update tests/README.md
        sed -i "s/<config-preflight.version>.*-SNAPSHOT<\/config-preflight.version>/<config-preflight.version>${{ inputs.release-version }}<\/config-preflight.version>/g" tests/README.md
        
    - name: Commit all updates
      run: |
        git add tests/*/pom.xml README.md DOCUMENTATION.md tests/README.md
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update demo projects to ${{ steps.next-version.outputs.next-snapshot }} and documentation to ${{ inputs.release-version }}"
        fi
        
    - name: Push changes and tags
      run: |
        git push origin main
        git push origin v${{ inputs.release-version }}
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ inputs.release-version }}
        release_name: Release ${{ inputs.release-version }}
        body: |
          Release version ${{ inputs.release-version }}
          
          ## Maven Central
          This release has been published to Maven Central.
          
          ```xml
          <dependency>
              <groupId>io.github.tourem</groupId>
              <artifactId>config-preflight-core</artifactId>
              <version>${{ inputs.release-version }}</version>
          </dependency>
          ```
        draft: false
        prerelease: false
